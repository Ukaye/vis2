<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Loan35 Admin</title>
    <meta name="description" content="Sufee Admin - HTML5 Admin Template">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="apple-icon.png">
    <link rel="shortcut icon" href="favicon.ico">

    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/themify-icons.css">
    <link rel="stylesheet" href="assets/css/flag-icon.min.css">
    <link rel="stylesheet" href="assets/css/cs-skin-elastic.css">
    <link rel="stylesheet" href="assets/css/lib/datatable/dataTables.bootstrap.min.css">
    <!-- <link rel="stylesheet" href="assets/css/bootstrap-select.less"> -->
    <link rel="stylesheet" href="assets/scss/style.css">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv.min.js"></script> -->
    <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
    <link rel="stylesheet" href="css/jquery.fileupload.css">
    <link rel="stylesheet" href="css/jquery.fileupload-ui.css">
    <!-- CSS adjustments for browsers with JavaScript disabled -->
    <noscript><link rel="stylesheet" href="css/jquery.fileupload-noscript.css"></noscript>
    <noscript><link rel="stylesheet" href="css/jquery.fileupload-ui-noscript.css"></noscript>
    <style type="text/css">
        ul.nav li.active p{color: #ffffff;}
        a, a p, a h4, a:hover{color: rgb(66, 139, 202);}
        li.disabled a p, li.disabled a h4 {color: #878787;}
        li.active a h4 {color: #ffffff;}
        table{width: 100%;}
        table th{text-align: center;}
        .alert-success, .alert-success p {color: #155724;}
        .modal-dialog{
            left: 0;
        }
        .thumbnail {
            padding:0px;
        }
        .panel {
            position:relative;
        }
        .panel>.panel-heading:after,.panel>.panel-heading:before{
            position:absolute;
            top:11px;left:-16px;
            right:100%;
            width:0;
            height:0;
            display:block;
            content:" ";
            border-color:transparent;
            border-style:solid solid outset;
            pointer-events:none;
        }
        .panel>.panel-heading:after{
            border-width:7px;
            border-right-color:#f7f7f7;
            margin-top:1px;
            margin-left:2px;
        }
        .panel>.panel-heading:before{
            border-right-color:#ddd;
            border-width:8px;
        }
        select.form-control{
            height: 36px !important;
        }
        ul.timeline {
            list-style-type: none;
            position: relative;
        }
        ul.timeline:before {
            content: ' ';
            background: #d4d9df;
            display: inline-block;
            position: absolute;
            left: 29px;
            width: 2px;
            height: 100%;
            z-index: 400;
        }
        ul.timeline > li {
            margin: 20px 0;
            padding-left: 60px;
        }
        ul.timeline > li:before {
            content: ' ';
            background: white;
            display: inline-block;
            position: absolute;
            border-radius: 50%;
            border: 3px solid #22c0e8;
            left: 20px;
            width: 20px;
            height: 20px;
            z-index: 400;
        }
        ul#workflow-ul-list li{
            padding: 5px 0;
        }
        .carousel {
            margin-bottom: 0;
            padding: 0 40px 30px 40px;
        }
        .carousel-control {
            left: -12px;
            height: 40px;
            width: 40px;
            background: none repeat scroll 0 0 #222222;
            border: 4px solid #FFFFFF;
            border-radius: 23px 23px 23px 23px;
            margin-top: 90px;
        }
        .carousel-control.right {
            right: -12px;
        }
        .carousel-indicators {
            right: 50%;
            top: auto;
            bottom: -10px;
            margin-right: -19px;
        }
        .carousel-indicators li {
            background: #cecece;
        }
        .carousel-indicators .active {
            background: #428bca;
        }
        .badge-success {
            background-color: #28a745;
        }
        .badge-danger {
            background-color: #dc3545;
        }
        .pb-0{
            text-align: center;
        }
    </style>
</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>
<!-- Left Panel -->
    <script type="text/javascript">
        jQuery(document).ready(function($){ check(); loadMenus(); read_write();});
    </script>

<aside id="left-panel" class="left-panel">
    <nav class="navbar navbar-expand-sm navbar-default">

        <div class="navbar-header">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fa fa-bars"></i>
            </button>
            <a class="navbar-brand" href="/dashboard">Loan 35</a>
            <a class="navbar-brand hidden" href="/dashboard">35</a>
        </div>

        <div id="main-menu" class="main-menu collapse navbar-collapse">
            <ul id="sidebar" class="nav navbar-nav">
            </ul>
        </div><!-- /.navbar-collapse -->
    </nav>
</aside><!-- /#left-panel -->
    <!-- Left Panel -->

    <!-- Right Panel -->
    <div id="right-panel" class="right-panel">
        <!-- Header-->
        <header id="header" class="header">

            <div class="header-menu">

                <div class="col-sm-7">
                    <a id="menuToggle" class="menutoggle pull-left"><i class="fa fa fa-tasks"></i></a>
                    <div class="header-left">
                        <button class="search-trigger"><i class="fa fa-search"></i></button>
                        <div class="form-inline">
                            <form class="search-form">
                                <input class="form-control mr-sm-2" type="text" placeholder="Search ..." aria-label="Search">
                                <button class="search-close" type="submit"><i class="fa fa-close"></i></button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-sm-5">
                    <div class="user-area dropdown float-right">
                        <strong id="user" style="margin-right:10px; vertical-align: sub"></strong>
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img class="user-avatar rounded-circle" src="images/admin.jpg" alt="User Avatar">
                        </a>

                        <div class="user-menu dropdown-menu">
                                <!-- <a class="nav-link" href="#"><i class="fa fa- user"></i>My Profile</a>

                                <a class="nav-link" href="#"><i class="fa fa- user"></i>Notifications <span class="count">13</span></a>

                                <a class="nav-link" href="#"><i class="fa fa -cog"></i>Settings</a> -->

                                <a class="nav-link pull-right" href="/logout"><i class="fa fa-power-off"></i> Logout</a>
                        </div>
                    </div>

                </div>
            </div>

        </header><!-- /header -->
        <!-- Header-->

        <div class="breadcrumbs">
            <div class="col-sm-4">
                <div class="page-header float-left">
                    <div class="page-title">
                        <h1>Application</h1>
                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <div class="page-header float-right">
                    <div class="page-title">
                        <ol class="breadcrumb text-right">
                            <li><a href="#">Dashboard</a></li>
                            <li><a href="#">Users</a></li>
                            <li class="active"><a href="/all-applications">All Applications</a></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <div class="content mt-3">
            <div class="animated fadeIn">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <strong id="workflow-div-title" class="card-title" style="float: left; margin: 15px;">Workflow</strong>
                                <button id="loan_closed" class ="btn btn-warning btn-lg" style="float: right; margin-top: 5px; display: none;" disabled="disabled"></button>
                                <div id="close-loan" class="btn-group" style="float: right; display: none;margin-top: 5px;">
                                    <button type="button" class="btn btn-danger btn-lg dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Close Loan
                                    </button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#payOffModal" onclick="openPayOffModal()">Pay Off</a>
                                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#writeOffModal" onclick="openWriteOffModal()">Write Off</a>
                                    </div>
                                </div>
                                <div id="next-actions" class="btn-group" style="float: right;">
                                    <button type="button" class="btn btn-success btn-lg dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="fa fa-forward"></i>
                                    </button>
                                    <div id="stage-actions" class="dropdown-menu">
                                        <a class="dropdown-item next" href="#">Save & Proceed</a>
                                        <div class="dropdown-divider"></div>
                                    </div>
                                </div>
                                <button id="current_stage" class ="btn btn-warning btn-lg" style="float: right;" disabled="disabled"></button>
                                <button class ="previous btn btn-danger btn-lg" style="float: right;"><i class="fa fa-backward"></i></button>
                                <span style="float: right; margin: 15px;">
                                    <a href="#" class="pull-right transitions-toggle">Show Transitions <i class="fa fa-chevron-down"></i></a>
                                    <a href="#" class="pull-right transitions-toggle" style="display: none;">Hide Transitions <i class="fa fa-chevron-up"></i></a>
                                </span>
                            </div>
                            <script type="text/javascript">
                                let $transitions_toggle = $('.transitions-toggle');
                                $transitions_toggle.click(function () {
                                    $('#transitions-list').toggle();
                                    $transitions_toggle.toggle();
                                });
                            </script>
                            <div class="card-body">
                                <div id="transitions-list" class="row form-group" style="display: none;">
                                    <div class="col-xs-12">
                                        <ul id="workflow-ul-list" class="nav nav-pills nav-justified thumbnail setup-panel"></ul>
                                    </div>
                                </div>
                                <div id="disbursement-cards" class="row setup-content" style="display: none;">
                                    <div class="col-sm-3">
                                        <div class="card text-white bg-flat-color-1">
                                            <div class="card-body pb-0">
                                                <h3 id="loan-amount-text" class="mb-0"></h3>
                                                <p class="text-light">Loan Balance</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="card text-white bg-flat-color-1">
                                            <div class="card-body pb-0">
                                                <h3 id="total-due-text" class="mb-0"></h3>
                                                <p class="text-light">Total Due Now</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="card text-white bg-flat-color-1">
                                            <div class="card-body pb-0">
                                                <h3 id="last-payment-text" class="mb-0"></h3>
                                                <p class="text-light">Last Payment</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="card text-white bg-flat-color-1">
                                            <div class="card-body pb-0">
                                                <h3 id="next-payment-date-text" class="mb-0"></h3>
                                                <p class="text-light">Next Payment Due Date</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row setup-content" id="document-upload" style="display: none;">
                                    <div class="col-xs-12">
                                        <div class="col-md-12 well">
                                            <h3 id="document-upload-text" style="margin-bottom: 5px;"></h3>

                                            <form id="fileupload" method="POST" enctype="multipart/form-data">
                                                <div class="row fileupload-buttonbar">
                                                    <div class="col-lg-7">
                                                        <span class="btn btn-success fileinput-button">
                                                            <i class="glyphicon glyphicon-plus"></i>
                                                            <span>Add file</span>
                                                            <input type="file" name="files[]" multiple>
                                                        </span>
                                                        <button type="submit" class="btn btn-primary start">
                                                            <i class="glyphicon glyphicon-upload"></i>
                                                            <span>Start upload</span>
                                                        </button>
                                                        <button type="reset" class="btn btn-warning cancel">
                                                            <i class="glyphicon glyphicon-ban-circle"></i>
                                                            <span>Cancel upload</span>
                                                        </button>
                                                        <!--<button type="button" class="btn btn-danger delete">-->
                                                            <!--<i class="glyphicon glyphicon-trash"></i>-->
                                                            <!--<span>Delete</span>-->
                                                        <!--</button>-->
                                                        <!--<input type="checkbox" class="toggle">-->
                                                        <!-- The global file processing state -->
                                                        <span class="fileupload-process"></span>
                                                    </div>
                                                    <div class="col-lg-5 fileupload-progress fade">
                                                        <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                                            <div class="progress-bar progress-bar-success" style="width:0%;"></div>
                                                        </div>
                                                        <div class="progress-extended">&nbsp;</div>
                                                    </div>
                                                </div>
                                                <table role="presentation" class="table table-striped" style="margin: 0"><tbody class="files"></tbody></table>
                                            </form>
                                        </div>
                                        <!-- The template to display files available for upload -->
                                        <script id="template-upload" type="text/x-tmpl">
                                            {% for (var i=0, file; file=o.files[i]; i++) { %}
                                                <tr class="template-upload fade">
                                                    <td>
                                                        <span class="preview"></span>
                                                    </td>
                                                    <td>
                                                        <p class="name">{%=file.name%}</p>
                                                        <strong class="error text-danger"></strong>
                                                    </td>
                                                    <td>
                                                        <p class="size">Processing...</p>
                                                        <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div>
                                                    </td>
                                                    <td>
                                                        {% if (!i && !o.options.autoUpload) { %}
                                                            <button class="btn btn-primary start" disabled>
                                                                <i class="glyphicon glyphicon-upload"></i>
                                                                <span>Start</span>
                                                            </button>
                                                        {% } %}
                                                        {% if (!i) { %}
                                                            <button class="btn btn-warning cancel">
                                                                <i class="glyphicon glyphicon-ban-circle"></i>
                                                                <span>Cancel</span>
                                                            </button>
                                                        {% } %}
                                                    </td>
                                                </tr>
                                            {% } %}
                                        </script>
                                        <!-- The template to display files available for download -->
                                        <script id="template-download" type="text/x-tmpl">
                                            {% for (var i=0, file; file=o.files[i]; i++) { %}
                                                <tr class="template-download fade">
                                                    <td>
                                                        <span class="preview">
                                                            {% if (file.thumbnailUrl) { %}
                                                                <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" data-gallery><img src="{%=file.thumbnailUrl%}"></a>
                                                            {% } %}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <p class="name">
                                                            {% if (file.url) { %}
                                                                <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" {%=file.thumbnailUrl?'data-gallery':''%}>{%=file.name%}</a>
                                                            {% } else { %}
                                                                <span>{%=file.name%}</span>
                                                            {% } %}
                                                        </p>
                                                        {% if (file.error) { %}
                                                            <div><span class="label label-danger">Error</span> {%=file.error%}</div>
                                                        {% } %}
                                                    </td>
                                                    <td>
                                                        <span class="size">{%=o.formatFileSize(file.size)%}</span>
                                                    </td>
                                                    <td>
                                                       {% if (file.deleteUrl) { %}
                                                            <button class="btn btn-danger delete" data-type="{%=file.deleteType%}" data-url="{%=file.deleteUrl%}"{% if (file.deleteWithCredentials) { %} data-xhr-fields='{"withCredentials":true}'{% } %}>
                                                                <i class="glyphicon glyphicon-trash"></i>
                                                                <span>Delete</span>
                                                            </button>
                                                            <input type="checkbox" name="delete" value="1" class="toggle">
                                                       {% } else { %}
                                                            <button class="btn btn-warning cancel">
                                                                <i class="glyphicon glyphicon-ban-circle"></i>
                                                                <span>Cancel</span>
                                                            </button>
                                                       {% } %}
                                                    </td>
                                                </tr>
                                            {% } %}
                                        </script>
                                        </div>
                                    </div>
                                <div class="row setup-content" id="schedule">
                                    <div class="col-xs-12">
                                        <div id="disburse-alert" class="alert alert-success" role="alert" style="display: none;">
                                            <h3 class="alert-heading">Loan has been disbursed!</h3>
                                            <p>Notifications would be sent to the user accounts related to this loan application to provide updates on this loan application.</p>
                                            <!--<hr>-->
                                            <!--<p class="mb-0">Please contact the admin for any issues with disbursement.</p>-->
                                        </div>
                                        <div class="col-md-12 well">
                                            <h2 class="text-center">Loan Overview
                                                <button id="collect-payment-button" class ="btn btn-primary" style="float: right; display: none;" onclick="goToLoanRepayment()">Collect Payment <i class="fa fa-money"></i></button>
                                            </h2>
                                            <div id="loanSchedule" style="margin-top: 30px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row setup-content" id="generate-schedule" style="display: none;">
                                    <div class="col-xs-12">
                                        <div class="col-md-12 well">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <h2 class="text-center">Upload Loan Schedule</h2>
                                                    <hr />
                                                    <div class="row">
                                                        <div class="col-sm-8">
                                                            <input type="file" id="csvUpload" style="display: inline-block"/>
                                                            <button id="uploadCSV" class="btn btn-info">Upload</button>
                                                            <button id="saveCSV" class="btn btn-success">Save</button>
                                                            <i id="csvLoader" class="fa fa-spinner fa-spin" style="display: none;"></i>
                                                        </div>
                                                        <div class="col-sm-4">
                                                            <a href="/Loan Schedule.csv" target="_blank" style="text-decoration: underline;">
                                                                Download Loan Schedule Template <i class="fa fa-cloud-download"></i></a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-12">
                                                    <div id="dvCSV" style="margin-top: 30px;"></div>
                                                    <hr />
                                                    <button id="btn-2" class="next btn btn-primary btn-lg">Save & Proceed</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row setup-content" id="generate-schedule-v2" style="display: none;">
                                    <div class="col-xs-12">
                                        <div class="col-md-12 well">
                                            <div class="row">
                                                <div class="col-sm-8">
                                                    <input type="file" id="csvUpload2" style="display: inline-block"/>
                                                    <button id="uploadCSV2" style="display: none" class="btn btn-info">Add Reschedule</button>
                                                    <button id="saveCSV2" style="display: none" class="btn btn-success">Save Reschedule</button>
                                                    <i id="csvLoader2" class="fa fa-spinner fa-spin" style="display: none;"></i>
                                                </div>
                                                <div class="col-sm-4">
                                                    <a href="/Loan Schedule.csv" target="_blank" style="text-decoration: underline;">
                                                        Download Loan Schedule Template <i class="fa fa-cloud-download"></i></a>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <div id="dvCSV2" style="margin-top: 30px;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row setup-content" id="files">
                                    <div class="col-xs-12">
                                        <div class="col-md-12 well">
                                            <h2 class="text-center" style="margin-bottom: 15px;">Uploaded Documents</h2>
                                            <div id="Carousel" class="carousel slide">
                                                <ol class="carousel-indicators"></ol>

                                                <!-- Carousel items -->
                                                <div class="carousel-inner"></div>

                                                <a data-slide="prev" href="#Carousel" class="left carousel-control">‹</a>
                                                <a data-slide="next" href="#Carousel" class="right carousel-control">›</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <script type="text/javascript">
                                    $(document).ready(function() {
                                        $('#Carousel').carousel({
                                            interval: 5000
                                        })
                                    });
                                </script>
                                <div class="row setup-content" id="denied" style="display: none;">
                                    <div class="col-xs-12">
                                        <div class="col-md-12 well">
                                            <div class="alert alert-danger" role="alert" style="margin-top: 15px;">
                                                <h3 class="alert-heading">Loan Application has been denied!</h3>
                                                <p>Notifications would be sent to the user accounts related to this loan application to provide updates on this loan request.</p>
                                                <hr>
                                                <p class="mb-0">Please contact the admin for any related issues.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <ul id="processes" class="timeline"></ul>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <span style="margin: 5px;">Comments</span>
                                <button class ="btn btn-info" style="float: right;" data-toggle="modal" data-target="#addCommentModal">Add Comment <i class="fa fa-comment"></i></button>
                            </div>
                            <div class="card-body">
                                <div id="comments"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- .animated -->
        <div id="wait" style=";width:150px;height:100px;position:absolute;top:50%;left:50%;padding:2px;"><img src='spinner.gif' width="100" height="100" style="background-color: transparent"/></div>
    </div><!-- .content -->
<!-- Right Panel -->

    <!-- Modal -->
    <div class="modal fade" id="addCommentModal" tabindex="-1" role="dialog" aria-labelledby="addCommentModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="addCommentModalLabel">Post Comment</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class=" form-control-label">Comment</label><strong style="color:red"> *</strong><span id="comment-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-comment"></i></div>
                                <textarea id="comment" class="form-control" required="required" maxlength="250" placeholder="Brief message"></textarea>
                            </div>
                            <small class="form-text text-muted">Maximum of 250 characters</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary write" data-dismiss="modal" onclick="comment()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="disburseModal" tabindex="-1" role="dialog" aria-labelledby="disburseModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="disburseModalLabel">Disburse Loan</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class=" form-control-label">Actual Disbursement Amount</label>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="disbursement-amount" type="text" class="form-control" placeholder="0" disabled="disabled">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Choose a Funding Source</label><strong style="color:red"> *</strong><span id="funding-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <select id="funding" class="form-control" required="required">
                                    <option selected="selected">-- Select a Funding Source --</option>
                                    <option value="Default">Default</option>
                                    <option value="Secondary">Secondary</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Choose a Disbursement Channel</label><strong style="color:red"> *</strong><span id="channel-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <select id="channel" class="form-control" required="required">
                                    <option selected="selected">-- Select a Channel --</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Disbursement Date</label><strong style="color:red"> *</strong><span id="disbursement-date-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-calendar"></i></div>
                                <input type="date" id="disbursement-date" class="form-control" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">First Repayment Date</label>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-calendar"></i></div>
                                <input type="date" id="repayment-date" class="form-control" required="required">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="disburse()">Disburse</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="writeOffModal" tabindex="-1" role="dialog" aria-labelledby="writeOffModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="writeOffModalLabel">Write Off Loan</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class=" form-control-label">Account Holders Name</label>
                            <div class="input-group">
                                <input id="writeoff-name" type="text" class="form-control" disabled="disabled">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Write Off Amount</label>
                            <div class="input-group">
                                <input id="writeoff-amount" type="text" class="form-control" disabled="disabled">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Notes</label>
                            <div class="input-group">
                                <textarea id="writeoff-notes" class="form-control" required="required" maxlength="250" placeholder="Brief message"></textarea>
                            </div>
                            <small class="form-text text-muted">Maximum of 250 characters</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="writeOffLoan()">Write Off</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="payOffModal" tabindex="-1" role="dialog" aria-labelledby="payOffModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="payOffModalLabel">Pay Off Loan</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class=" form-control-label">Payoff Amount</label>
                            <div class="input-group">
                                <input id="payoff-amount" type="text" class="form-control" disabled="disabled">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Write off interest amount</label><strong style="color:red"> *</strong>
                            <div class="input-group">
                                <input id="payoff-interest" type="number" class="form-control" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Enter Date</label><strong style="color:red"> *</strong>
                            <div class="input-group">
                                <input id="payoff-date" type="date" class="form-control" required="required">
                            </div>
                            <small class="form-text text-muted">Note, repayment date cannot be a future date</small>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Choose a Disbursement Channel</label><strong style="color:red"> *</strong>
                            <div class="input-group">
                                <select id="payoff-channel" class="form-control" required="required">
                                    <option selected="selected">-- Select a Channel --</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Include on-hand interest</label>
                            <div class="input-group">
                                <div class="radio">
                                    <label><input type="radio" name="payoff-include-interest" value="Daily">Daily</label>
                                </div>
                                <div class="radio">
                                    <label><input type="radio" name="payoff-include-interest" value="Monthly">Monthly</label>
                                </div>
                                <div class="radio">
                                    <label><input type="radio" name="payoff-include-interest" value="All">All</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Notes</label>
                            <div class="input-group">
                                <textarea id="payoff-notes" class="form-control" required="required" maxlength="250" placeholder="Brief message"></textarea>
                            </div>
                            <small class="form-text text-muted">Maximum of 250 characters</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="payOffLoan()">Pay Off</button>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/popper.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/plugins.js"></script>
    <script src="assets/js/main.js"></script>


    <script src="assets/js/lib/data-table/datatables.min.js"></script>
    <script src="assets/js/lib/data-table/dataTables.bootstrap.min.js"></script>
    <script src="assets/js/lib/data-table/dataTables.buttons.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.bootstrap.min.js"></script>
    <script src="assets/js/lib/data-table/jszip.min.js"></script>
    <script src="assets/js/lib/data-table/pdfmake.min.js"></script>
    <script src="assets/js/lib/data-table/vfs_fonts.js"></script>
    <script src="assets/js/lib/data-table/buttons.html5.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.print.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.colVis.min.js"></script>
    <script src="assets/js/lib/data-table/datatables-init.js"></script>

    <!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
    <script src="js/vendor/jquery.ui.widget.js"></script>
    <!-- The Templates plugin is included to render the upload/download listings -->
    <script src="https://blueimp.github.io/JavaScript-Templates/js/tmpl.min.js"></script>
    <!-- The Load Image plugin is included for the preview images and image resizing functionality -->
    <script src="https://blueimp.github.io/JavaScript-Load-Image/js/load-image.all.min.js"></script>
    <!-- The Canvas to Blob plugin is included for image resizing functionality -->
    <script src="https://blueimp.github.io/JavaScript-Canvas-to-Blob/js/canvas-to-blob.min.js"></script>
    <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
    <script src="js/jquery.iframe-transport.js"></script>
    <!-- The basic File Upload plugin -->
    <script src="js/jquery.fileupload.js"></script>
    <!-- The File Upload processing plugin -->
    <script src="js/jquery.fileupload-process.js"></script>
    <!-- The File Upload image preview & resize plugin -->
    <script src="js/jquery.fileupload-image.js"></script>
    <!-- The File Upload audio preview plugin -->
    <script src="js/jquery.fileupload-audio.js"></script>
    <!-- The File Upload video preview plugin -->
    <script src="js/jquery.fileupload-video.js"></script>
    <!-- The File Upload validation plugin -->
    <script src="js/jquery.fileupload-validate.js"></script>
    <!-- The File Upload user interface plugin -->
    <script src="js/jquery.fileupload-ui.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            loadUsers();
            loadComments();
        });

        $(document).ajaxStart(function(){
            $("#wait").css("display", "block");
        });

        $(document).ajaxComplete(function(){
            $("#wait").css("display", "none");
        });

        const urlParams = new URLSearchParams(window.location.search);
        const application_id = urlParams.get('id');

        function goToLoanRepayment() {
            window.location.href = '/loan-repayment?id='+application_id;
        }

        function check(){
            if (localStorage.getItem('role') != 1){
                jQuery('#car-models').hide();
                jQuery('#new-user').hide();
                jQuery('#models-card').hide();
                jQuery('#user').html(localStorage.getItem("name"));
            }
            else{
                jQuery('#user').html(localStorage.getItem("name"));
            }
        }

        function loadMenus(){
            var modules = {};
            modules = JSON.parse(localStorage.getItem("modules"));
            modules.forEach(function(k, v){
                if (k.menu_name === 'Sub Menu'){
                    let main = $.grep(modules, function(e){return e.id === parseInt(k.main_menu);});
                    $('#'+$(main[0]['module_tag']).attr('id') + ' > .sub-menu').append(k.module_tag);
                }else if(k.menu_name === 'Main Menu'){
                    $('#sidebar').append(k.module_tag);
                    $('#'+$(k.module_tag).attr('id')).append('<ul class="sub-menu children dropdown-menu"></ul>');
                }else{
                    $('#'+k.module_name).show();
                }
            });
            $.ajax({
                type: "GET",
                url: "/user/all-requests",
                success: function (response) {
                    $.each(response, function(k,v){
                        $('#requests-badge').html(v.requests);
                    });
                }
            });
            $.ajax({
                type: "GET",
                url: "/user/all-applications",
                success: function (response) {
                    $.each(response, function(k,v){
                        $('#applications-badge').html(v.applications);
                    });
                }
            });
        }

        function read_write(){
            let w;
            var perms = JSON.parse(localStorage.getItem("permissions"));
            var page = (window.location.pathname.split('/')[1].split('.'))[0];
            perms.forEach(function (k,v){
                if (k.module_name === page){
                    w = $.grep(perms, function(e){return e.id === parseInt(k.id);});
                }
            });
            if (parseInt(w[0]['editable']) != 1){
                $(".write").hide();
            }
        }

        let workflow,
            application;

        function loadUsers(){
            $.ajax({
                'url': '/user/application-id/'+application_id,
                'type': 'get',
                'success': function (result) {
                    let data = result.response,
                        file_names = Object.keys(data.files),
                        files_count = file_names.length,
                        $carousel_inner = $('.carousel-inner'),
                        $carousel_indicators = $('.carousel-indicators');

                    application = data;
                    getWorkflows(application);
                    loadWorkflowState();

                    if (application.schedule && application.schedule[0]){
                        $("#generate-schedule").hide();
                        $("#schedule").show();
                    } else {
                        $("#generate-schedule").show();
                    }

                    if (files_count < 1){
                        $carousel_inner.append('<h3>No Documents Uploaded Yet!</h3>');
                    } else {
                        let count = 0,
                            pages = parseInt(files_count/4);
                        for (let i=0; i<=pages; i++){
                            if (i === 0){
                                $carousel_inner.append('<div class="item active"><div class="row page-0"></div></div>');
                                $carousel_indicators.append('<li data-target="#Carousel" data-slide-to="0" class="active"></li>');
                            } else {
                                $carousel_inner.append('<div class="item"><div class="row page-'+i+'"></div></div>');
                                $carousel_indicators.append('<li data-target="#Carousel" data-slide-to="'+i+'"></li>');
                            }
                            for (let j=0; j<4; j++){
                                if (count < files_count)
                                    $('.page-'+i).append('<div class="col-md-3"><a href="#" class="thumbnail"><img src="'+application.files[file_names[count]]+'" alt="'+file_names[count].replace(/_/g, ' ')+'" style="max-width:100%; height: 200px;"></a><p style="text-align: center;">'+file_names[count].replace(/_/g, ' ')+'</p></div>');
                                count++;
                            }
                        }
                    }

                    initCSVUpload(application);
                    initCSVUpload2(application);
                },
                'error': function (err) {
                    console.log('Error');
                }
            });
        }

        function getWorkflows(data){
            $.ajax({
                type: "GET",
                url: "/workflows",
                success: function (response) {
                    localStorage.setItem("workflows",JSON.stringify(response.response));
                    let fullname = data.fullname || '';
                    workflow = (response.response)? ($.grep(response.response, function(e){ return e.ID === data.workflowID; }))[0] : {name:'Workflow'};
                    $("#workflow-div-title").text(fullname.toUpperCase()+" ("+workflow.name+")");
                }
            });
        }

        function loadComments(comments) {
            if (comments && comments[0]){
                let $comments = $('#comments');
                $comments.html('');
                comments.forEach(function (comment) {
                    $comments.append('<div class="row">\n' +
                        '    <div class="col-sm-2">\n' +
                        '        <div class="thumbnail"><img class="img-responsive user-photo" src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png"></div>\n' +
                        '    </div>\n' +
                        '    <div class="col-sm-10">\n' +
                        '        <div class="panel panel-default">\n' +
                        '            <div class="panel-heading"><strong>'+comment.fullname+'</strong> <span class="text-muted">commented on '+comment.date_created+'</span></div>\n' +
                        '            <div class="panel-body">'+comment.text+'</div>\n' +
                        '        </div>\n' +
                        '    </div>\n' +
                        '</div>');
                });
            } else {
                $.ajax({
                    'url': '/user/application/comments/'+application_id,
                    'type': 'get',
                    'success': function (data) {
                        let comments = data.response,
                            $comments = $('#comments');
                        $comments.html('');
                        if (!comments[0])
                            return $comments.append('<h2 style="margin: auto;">No comments available yet!</h2>');
                        comments.forEach(function (comment) {
                            $comments.append('<div class="row">\n' +
                                '    <div class="col-sm-2">\n' +
                                '        <div class="thumbnail"><img class="img-responsive user-photo" src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png"></div>\n' +
                                '    </div>\n' +
                                '    <div class="col-sm-10">\n' +
                                '        <div class="panel panel-default">\n' +
                                '            <div class="panel-heading"><strong>'+comment.fullname+'</strong> <span class="text-muted">commented on '+comment.date_created+'</span></div>\n' +
                                '            <div class="panel-body">'+comment.text+'</div>\n' +
                                '        </div>\n' +
                                '    </div>\n' +
                                '</div>');
                        });
                    },
                    'error': function (err) {
                        console.log('Error');
                        swal('No internet connection');
                    }
                });
            }
        }

        let stage_document = false;
        $('.next').hide();
        $('.previous').hide();
        $('#next-actions').hide();
        $('#current_stage').hide();
        function loadWorkflowStages(state) {
            $.ajax({
                'url': '/workflow-stages/'+state.workflowID,
                'type': 'get',
                'success': function (data) {
                    $('.next').show();
                    $('.previous').show();
                    $('#next-actions').show();
                    $('#current_stage').show();

                    let count = 0,
                        workflow_stages = data.response,
                        ul = document.getElementById('workflow-ul-list'),
                        $last_btn = $("#btn-"+workflow_stages[workflow_stages.length-1]['stageID']),
                        stage = ($.grep(workflow_stages, function(e){ return e.stageID === state.current_stage; }))[0];

                    $last_btn.hide();
                    $('#current_stage').text(stage.name);
                    if (stage.stage_name === 'Application Start' && (!application.schedule || !application.schedule[0])){
                        $('#schedule').hide();
                        $('#generate-schedule').show();
                    }

                    if (stage.document){
                        $('#document-upload').show();
                        $('#document-upload-text').append('<i class="fa fa-warning"></i> Kindly upload a '+stage.document);
                        stage_document = stage.document;
                        fileUpload(stage);
                    }

                    if (stage.actions){
                        let actions = stage.actions.split(',');
                        actions.forEach(function (code) {
                            let stage_template = ($.grep(workflow_stages, function(e){ return e.code === code; }))[0];
                            $('#stage-actions').append('<a href="#" class="dropdown-item" id="stage-action-'+stage_template.stageID+'">'
                                +stage_template.name+' ('+stage_template.stage_name+')</a>');
                        });
                    }

                    $("#stage-actions").on('click', function (e) {
                        let id = (e.target.id.split('-'))[2];
                        if (!id){
                            nextStage(state);
                        } else {
                            if (id !== '0')
                                nextStage(state, workflow_stages, id);
                        }
                    });

                    workflow_stages.forEach(function (stage) {
                        if (stage.stage_name !== 'Denied'){
                            let index =  workflow_stages.map(function(e) { return e.stageID; }).indexOf(state.current_stage),
                                li = document.createElement('li');
                            if (count === index){
                                li.className = "active";
                                if (count === 0)
                                    $(".previous").hide();
                                if (count === workflow_stages.length-1)
                                    $(".next").hide();
                            } else if (count > index) {
                                li.className = "disabled";
                            }
                            ul.appendChild(li);
                            count++;
                            li.innerHTML += '<a><h4 class="list-group-item-heading">Step '+count+'</h4>\n' +
                                '<p class="list-group-item-text">'+stage.name+'<br> ('+stage.stage_name+')</p></a>';
                        }
                    });

                    if (stage.stage_name === 'Denied'){
                        $("#current_stage").hide();
                        $("#next-actions").hide();
                        $(".previous").hide();
                        $("#schedule").hide();
                        $("#denied").show();
                        $("#files").hide();
                        $(".next").hide();

                        let li = document.createElement('li');
                        li.className = "active";
                        ul.appendChild(li);
                        li.innerHTML += '<a><h4 class="list-group-item-heading">Step '+(count+1)+'</h4>\n' +
                            '<p class="list-group-item-text">'+stage.name+'<br> ('+stage.stage_name+')</p></a>';
                    }

                    if (stage.stage_name === 'Disbursal'){
                        if (application.status === 2){
                            $('#collect-payment-button').show();
                            $('#generate-schedule-v2').show();
                            $('#disbursement-cards').show();
                            $('#disburse-alert').show();
                            $("#current_stage").hide();
                            $("#next-actions").hide();
                            $(".previous").hide();
                            $(".next").hide();

                            if (application.close_status === 0){
                                $('#close-loan').show();
                            } else {
                                $('#loan_closed').show();
                                if (application.close_status === 1){
                                    $('#loan_closed').html('<strong>CLOSED </strong> | PAID OFF');
                                } else if (application.close_status === 2){
                                    $('#loan_closed').html('<strong>CLOSED </strong> | WRITTEN OFF');
                                }
                            }

                            $('#loan-amount-text').text('₦'+(parseFloat(application.loan_amount)).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                            if (!application.payment_history || !application.payment_history[0]){
                                $('#total-due-text').text('₦'+(parseFloat(application.loan_amount)).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                                $('#last-payment-text').text('N/A');
                            } else {
                                let count = 0,
                                    amount = parseFloat(application.loan_amount);
                                application.payment_history.forEach(function (payment) {
                                    count++;
                                    amount = amount - parseFloat(payment.payment_amount);
                                    if (count === application.payment_history.length)
                                        $('#total-due-text').text('₦'+(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                                });
                                $('#last-payment-text').text(((application.payment_history[0]['date_created']).split(' '))[0]);
                            }
                            let next_payment_date = $.grep(application.schedule,function(e){return (e.payment_status===0 && e.status===1)});
                            if (next_payment_date && next_payment_date[0]){
                                let date_array = (((next_payment_date[0]['payment_create_date']).split(' '))[0]).split('-');
                                $('#next-payment-date-text').text('20'+date_array[2]+'-'+date_array[1]+'-'+date_array[0]);
                            } else {
                                $('#next-payment-date-text').text('N/A');
                            }
                        }
                        $('#disbursement-amount').val((parseFloat(application.loan_amount)).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                        $('#stage-actions').append('<a href="#" id="stage-action-0" class="dropdown-item" data-toggle="modal" data-target="#disburseModal">Disburse Loan</a>');
                    }

                    loadAllWorkflowState(workflow_stages);
                },
                'error': function (err) {
                    console.log('Error');
                    swal('No internet connection');
                }
            });
        }

        function loadWorkflowState() {
            $.ajax({
                'url': '/user/workflow_process/'+application_id,
                'type': 'get',
                'success': function (data) {
                    let states = data.response,
                        state = states[states.length-1],
                        allWells = $('.setup-content');

                    loadWorkflowStages(state);
                    allWells.hide();

                    $('.previous').on('click', function(e) {
                        previousStage(state,states);
                    });

                    $('#schedule').show();
                    $('#files').show();
                },
                'error': function (err) {
                    console.log('Error');
                    swal('No internet connection');
                }
            });
        }

        function loadAllWorkflowState(workflow_stages) {
            $.ajax({
                'url': '/user/workflow_process_all/'+application_id,
                'type': 'get',
                'success': function (data) {
                    let states = data.response,
                        $processes = $('#processes');

                    $processes.html('');
                    if (!states[0])
                        return $processes.append('<h3 style="margin: auto;">No transitions available yet!</h3>');
                    states.forEach(function (state) {
                        let previous_stage = ($.grep(workflow_stages, function(e){ return e.stageID === state.previous_stage; }))[0] || {stage_name:'N/A'},
                            current_stage = ($.grep(workflow_stages, function(e){ return e.stageID === state.current_stage; }))[0] || {stage_name:''};
                        $processes.append('<li>\n' +
                            '    <p><a href="#">'+current_stage.stage_name+'</a></p>\n' +
                            '    <p><a href="#">'+state.date_created+'</a></p>\n' +
                            '    <p>Moved from '+previous_stage.stage_name+' to '+current_stage.stage_name+'</p>\n' +
                            '</li>');
                    });
                },
                'error': function (err) {
                    console.log('Error');
                    swal('No internet connection');
                }
            });
        }

        function nextStage(state, workflow_stages, action_stage) {
            let stage = {};
            if (workflow_stages && action_stage){
                stage.previous_stage = workflow_stages.map(function(e) { return e.stageID; }).indexOf(state.current_stage);
                stage.current_stage = action_stage;
            }
            if (stage_document && !(stage_document.replace(/ /g, '_') in application.files))
                return swal('Kindly upload required document ('+stage_document+')');
            if (!application.schedule || (application.schedule && !application.schedule[0]))
                return swal('Kindly upload loan schedule to proceed!');
            $.ajax({
                'url': '/user/workflow_process/'+application_id+'/'+state.workflowID,
                'type': 'post',
                'data': {stage: stage, user_role:localStorage.getItem('role')},
                'success': function (data) {
                    if (data.status === 200){
                        $('#document-upload').hide();
                        $('#document-upload-text').text('');
                        swal('Workflow updated successfully!');
                        window.location.reload();
                    } else {
                        if (data.message){
                            swal(data.message);
                        } else {
                            swal('No internet connection');
                        }
                    }
                },
                'error': function (err) {
                    console.log('Error');
                    swal('No internet connection');
                }
            });
        }

        function previousStage(state,states) {
            $.ajax({
                'url': '/user/revert_workflow_process/'+application_id,
                'type': 'get',
                'success': function (data) {
                    if (data.status === 200){
                        $('#document-upload').hide();
                        $('#document-upload-text').text('');
                        swal('Workflow updated successfully!');
                        window.location.reload();
                    } else {
                        if (data.message){
                            swal(data.message);
                        } else {
                            swal('No internet connection');
                        }
                    }
                },
                'error': function (err) {
                    console.log('Error');
                    swal('No internet connection');
                }
            });
        }

        function comment(){
            let $comment = $("#comment"),
                comment = $comment.val();
            if (!comment || comment === ""){
                $comment.val("");
                return swal('Kindly type a brief comment');
            }
            $.ajax({
                'url': '/user/application/comments/'+application_id,
                'type': 'post',
                'data': {text: comment},
                'success': function (data) {
                    let comments = data.response;
                    results = comments;
                    loadComments(comments);
                    $comment.val("");
                    swal('Comment saved successfully');
                },
                'error': function (err) {
                    $comment.val("");
                    swal('Oops! An error occurred while saving comment');
                }
            });
        }

        function fileUpload(stage) {
            let $fileupload = $('#fileupload'),
                stage_document_name = stage.document.replace(/ /g, '_');

            $fileupload.fileupload({
                url: 'document-upload/'+application_id+'/'+stage_document_name,
                disableImageResize: /Android(?!.*Chrome)|Opera/
                    .test(window.navigator.userAgent),
                maxFileSize: 999000,
                acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i
            });

            $fileupload.addClass('fileupload-processing');
            $.ajax({
                url: $fileupload.fileupload('option', 'url'),
                context: $fileupload[0]
            }).always(function () {
                $(this).removeClass('fileupload-processing');
            }).done(function (result) {
                $(this).fileupload('option', 'done')
                    .call(this, $.Event('done'), {result: result});
            });
        }

        function initCSVUpload(application) {
            let schedule = [],
                $dvCSV = $("#dvCSV"),
                $saveCSV = $("#saveCSV"),
                $csvUpload = $("#csvUpload"),
                $uploadCSV = $("#uploadCSV"),
                $csvLoader = $("#csvLoader");

            $uploadCSV.bind("click", function () {
                let regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
                if (regex.test($csvUpload.val().toLowerCase())) {
                    if (typeof (FileReader) !== "undefined") {
                        let reader = new FileReader();
                        reader.onload = function (e) {
                            let table = $("<table border='1' style='text-align: center;'/>"),
                                rows = e.target.result.split("\n");
                            for (let i = 0; i < rows.length; i++) {
                                let invoice = {},
                                    row = $("<tr />"),
                                    cells = rows[i].split(",");
                                if (i === 0) {
                                    cells = ["PRINCIPAL","INTEREST","BALANCE"];
                                } else if (i === 1) {
                                    cells = ["INVOICE DATE","COLLECTION DATE","AMOUNT","INVOICE DATE","COLLECTION DATE","AMOUNT","AMOUNT"];
                                }
                                for (let j = 0; j < cells.length; j++) {
                                    let cell = $("<td />");
                                    if (i === 0){
                                        if ((cells[j] === "PRINCIPAL") || cells[j] === "INTEREST")
                                            cell = $("<td colspan='3' />");
                                    }
                                    cell.html(cells[j]);
                                    row.append(cell);
                                    switch (j){
                                        case 0:{ invoice.payment_create_date = cells[j]; break; }
                                        case 1:{ invoice.payment_collect_date = cells[j]; break; }
                                        case 2:{ invoice.payment_amount = cells[j]; break; }
                                        case 3:{ invoice.interest_create_date = cells[j]; break; }
                                        case 4:{ invoice.interest_collect_date = cells[j]; break; }
                                        case 5:{ invoice.interest_amount = cells[j]; break; }
                                        case 6:{ invoice.balance = cells[j]; break; }
                                    }
                                }
                                if (i>1 && cells.length === 7)
                                    schedule.push(invoice);
                                table.append(row);
                            }
                            $dvCSV.html('');
                            $dvCSV.append(table);
                        };
                        reader.readAsText($csvUpload[0].files[0]);
                    } else {
                        return swal('This browser does not support HTML5.');
                    }
                } else {
                    return swal('Please select a valid CSV file.');
                }
            });

            $saveCSV.bind("click", function () {
                if (!schedule[0])
                    return swal('Please upload a valid CSV file.');

                $csvLoader.show();
                $.ajax({
                    'url': '/user/application/schedule/'+application_id,
                    'type': 'post',
                    'data': {schedule:schedule},
                    'success': function (data) {
                        $csvLoader.hide();
                        $csvUpload.val('');
                        swal('Schedule saved successfully');
                        window.location.reload();
                    },
                    'error': function (err) {
                        $csvLoader.hide();
                        $csvUpload.val('');
                        swal('Oops! An error occurred while saving schedule');
                    }
                });
            });

            let $loanSchedule = $("#loanSchedule");
            if (application.schedule && application.schedule[0]){
                let table = $("<table border='1' style='text-align: center;'/>");
                for (let i = 0; i < application.schedule.length+2; i++) {
                    let row,
                        cells = [];
                    if (i <= 1){
                        row = $('<tr style="font-weight: bold;" />');
                    } else {
                        row = $("<tr />");
                        if (parseInt(application.schedule[i - 2]['status']) === 0)
                            row = $("<tr style='background-color: #aaaaaa; text-decoration: line-through;' />");
                    }
                    if (i === 0) {
                        cells = ["PRINCIPAL","INTEREST","BALANCE","COLLECTION"];
                    } else if (i === 1) {
                        cells = ["INVOICE DATE","COLLECTION DATE","AMOUNT","INVOICE DATE","COLLECTION DATE","AMOUNT","AMOUNT","STATUS"];
                    } else {
                        cells[0] = application.schedule[i - 2]['payment_create_date'];
                        cells[1] = application.schedule[i - 2]['payment_collect_date'];
                        cells[2] = application.schedule[i - 2]['payment_amount'];
                        cells[3] = application.schedule[i - 2]['interest_create_date'];
                        cells[4] = application.schedule[i - 2]['interest_collect_date'];
                        cells[5] = application.schedule[i - 2]['interest_amount'];
                        cells[6] = application.schedule[i - 2]['balance'];
                        cells[7] = application.schedule[i - 2]['payment_status'];
                    }
                    for (let j = 0; j < cells.length; j++) {
                        let cell = $("<td />");
                        if (i === 0){
                            if ((cells[j] === "PRINCIPAL") || cells[j] === "INTEREST")
                                cell = $("<td colspan='3' />");
                        }
                        if (j === cells.length-1 && i>1){
                            if (parseInt(cells[j]) === 0){
                                cell.html('<span class="badge badge-danger">Not Paid</span>');
                            } else {
                                cell.html('<span class="badge badge-success">Paid</span>');
                            }
                        } else {
                            cell.html(cells[j]);
                        }
                        row.append(cell);
                    }
                    table.append(row);
                }
                $loanSchedule.html('');
                $loanSchedule.append(table);
            }
        }

        function disburse() {
            let disbursal = {};
            disbursal.funding_source = $('#funding').val();
            disbursal.disbursement_channel = $('#channel').val();
            disbursal.disbursement_date = $('#disbursement-date').val();
            disbursal.repayment_date = $('#repayment-date').val();
            if (!disbursal.funding_source || !disbursal.disbursement_channel || !disbursal.disbursement_date)
                return swal('Kindly fill all required fields!');

            $.ajax({
                'url': '/user/application/disburse/'+application_id,
                'type': 'post',
                'data': disbursal,
                'success': function (data) {
                    swal('Loan disbursed successfully');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('Oops! An error occurred while disbursing loan');
                }
            });
        }

        function initCSVUpload2(application) {
            let schedule = [],
                $dvCSV = $("#dvCSV2"),
                $saveCSV = $("#saveCSV2"),
                $csvUpload = $("#csvUpload2"),
                $uploadCSV = $("#uploadCSV2"),
                $csvLoader = $("#csvLoader2");

            $uploadCSV.bind("click", function () {
                let regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
                if (regex.test($csvUpload.val().toLowerCase())) {
                    if (typeof (FileReader) !== "undefined") {
                        let reader = new FileReader();
                        reader.onload = function (e) {
                            let table = $("<table border='1' style='text-align: center;'/>"),
                                rows = e.target.result.split("\n");
                            for (let i = 0; i < rows.length; i++) {
                                let invoice = {},
                                    row = $("<tr />"),
                                    cells = rows[i].split(",");
                                if (i === 0) {
                                    cells = ["PRINCIPAL","INTEREST","BALANCE"];
                                } else if (i === 1) {
                                    cells = ["INVOICE DATE","COLLECTION DATE","AMOUNT","INVOICE DATE","COLLECTION DATE","AMOUNT","AMOUNT"];
                                }
                                for (let j = 0; j < cells.length; j++) {
                                    let cell = $("<td />");
                                    if (i === 0){
                                        if ((cells[j] === "PRINCIPAL") || cells[j] === "INTEREST")
                                            cell = $("<td colspan='3' />");
                                    }
                                    cell.html(cells[j]);
                                    row.append(cell);
                                    switch (j){
                                        case 0:{ invoice.payment_create_date = cells[j]; break; }
                                        case 1:{ invoice.payment_collect_date = cells[j]; break; }
                                        case 2:{ invoice.payment_amount = cells[j]; break; }
                                        case 3:{ invoice.interest_create_date = cells[j]; break; }
                                        case 4:{ invoice.interest_collect_date = cells[j]; break; }
                                        case 5:{ invoice.interest_amount = cells[j]; break; }
                                        case 6:{ invoice.balance = cells[j]; break; }
                                    }
                                }
                                if (i>1 && cells.length === 7)
                                    schedule.push(invoice);
                                table.append(row);
                            }
                            $dvCSV.html('');
                            $dvCSV.append(table);
                        };
                        reader.readAsText($csvUpload[0].files[0]);
                    } else {
                        return swal('This browser does not support HTML5.');
                    }
                } else {
                    return swal('Please select a valid CSV file.');
                }
            });

            $saveCSV.bind("click", function () {
                if (!schedule[0])
                    return swal('Please upload a valid CSV file.');

                $csvLoader.show();
                $.ajax({
                    'url': '/user/application/schedule/'+application_id,
                    'type': 'post',
                    'data': {schedule:schedule},
                    'success': function (data) {
                        $csvLoader.hide();
                        $csvUpload.val('');
                        swal('Schedule saved successfully');
                        window.location.reload();
                    },
                    'error': function (err) {
                        $csvLoader.hide();
                        $csvUpload.val('');
                        swal('Oops! An error occurred while saving schedule');
                    }
                });
            });
        }
        
        function openPayOffModal() {
            $('#payoff-amount').val($('#total-due-text').text());
            let interest = 0;
            let invoices = $.grep(application.schedule,function (e) {return (parseInt(e.status)===1 && parseInt(e.payment_status)===0)});
            if (invoices && invoices[0]){
                invoices.forEach(function (invoice) {
                    interest += parseFloat(invoice.interest_amount);
                    $('#payoff-interest').val(interest);
                });
            } else {
                $('#payoff-interest').val(0);
            }
        }

        function openWriteOffModal() {
            $('#writeoff-name').val(application.fullname);
            $('#writeoff-amount').val($('#total-due-text').text());
        }
        
        function writeOffLoan() {
            $.ajax({
                'url': '/user/application/write-off/'+application_id,
                'type': 'post',
                'data': {close_comment:$('#writeoff-notes').val()},
                'success': function (data) {
                    swal('Loan closed successfully');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('Oops! An error occurred while closing loan');
                }
            });
        }

        function payOffLoan() {
            let payoff = {};
            payoff.close_interest = $('#payoff-interest').val();
            payoff.close_date = $('#payoff-date').val();
            payoff.close_channel = $('#payoff-channel').val();
            payoff.close_comment = $('#payoff-notes').val();
            if ($('input[name=payoff-include-interest]:checked').val())
                payoff.close_include_interest = $('input[name=payoff-include-interest]:checked').val();
            if (!payoff.close_interest || !payoff.close_date || !payoff.close_channel)
                return swal('Kindly fill all required inputs to close loan');
            $.ajax({
                'url': '/user/application/pay-off/'+application_id,
                'type': 'post',
                'data': payoff,
                'success': function (data) {
                    swal('Loan closed successfully');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('Oops! An error occurred while closing loan');
                }
            });
        }
    </script>
</body>
</html>
